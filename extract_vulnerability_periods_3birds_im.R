# SCRIPT NO. 2
#extracting vulnerability period from observed and simulated streamflow for 3 bird species

library("lubridate")
library("dplyr")
library("tibble")

setwd ("D:/Ptaki_hydro/Obliczenia/R/IHA")

Q_mod <- data.frame( read.csv("Q_modelled.csv"))

#island locations paired with subbasins
island_reach <- data.frame( read.csv("wyspa_subbasin.csv"))

#Narrow down the Q data to subbasins with islands
Q_mod_Wisla <- Q_mod[Q_mod$RCH %in% island_reach$Subbasin, ] #there are 19 subbasins as 3 describe double bird islands

#write.csv(Q_mod_Wisla, "Q_mod_Wisla.csv")
#Q_mod_Wisla <- data.frame( read.csv("Q_mod_Wisla.csv"))

#because data was read from a csv file the dates were converted to factor, now they need to be converted to date again
Q_mod_Wisla$date <- as.Date(Q_mod_Wisla$mdate, format="%Y-%m-%d")


#yyyy-mm-dd
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

# Setting the order of RCH for display 
ord_table_m <- table(Q_mod_Wisla$RCH)
ord_levels_m <- names(ord_table_m)[order(ord_table_m)]
Q_mod_Wisla$RCH2 <- factor(Q_mod_Wisla$RCH, levels = ord_levels_m)


# Setting the order of RCH for display, this links to code hydro_stations.R
ord_table <- table(obs_Wisla$RCH)
ord_levels <- names(ord_table)[order(ord_table)]
obs_Wisla$RCH2 <- factor(obs_Wisla$RCH, levels = ord_levels)


#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
#%%%%%%%%%%%%%%%%%%%%%%%%%%%% BLACK HEADED GULL (BHG) %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
#Narrowing the data to vulnerability period for black headed gull : 11.04 - 10.06
#black-headed gull #Śmieszka #(Chroicocephalus ridibundus)

###### MODELLED Q 
bh.gull_interv <- as.interval(ddays(61), start = ISOdate(2004:2018, 4, 11, 0, tz = 'Europe/Warsaw'))
bh.gull_is.breeding <- Q_mod_Wisla$date %within% as.list(bh.gull_interv)
bh.gull_dat <- (Q_mod_Wisla$date)[which(bh.gull_is.breeding)]

#Narrow down the Q data to vulnerability period
bh.gull_Q_mod <- Q_mod_Wisla[Q_mod_Wisla$date %in% bh.gull_dat, ] 

bh.gull_Q_mod$Year <- format(as.Date(bh.gull_Q_mod$date, format="%Y-%m-%d"),"%Y")

#list with each year as separate data frame
#former Smieszka_list
bh.gull_Q_mod_list <- bh.gull_Q_mod %>% group_split(bh.gull_Q_mod$Year)

###### OBSERVED Q 

bh.gull_is.breeding.obs <- obs_Wisla$date %within% as.list(bh.gull_interv)
bh.gull_dat2 <- (obs_Wisla$date)[which(bh.gull_is.breeding.obs)]

#Narrow down the Q data to vulnerability period
bh.gull_Q_obs <- obs_Wisla[obs_Wisla$date %in% bh.gull_dat2, ] 

bh.gull_Q_obs$Year <- format(as.Date(bh.gull_Q_obs$date, format="%Y-%m-%d"),"%Y")

#list with each year as separate data frame
#former Smieszka_obs_list
bh.gull_Q_obs_list <- bh.gull_Q_obs %>% group_split(bh.gull_Q_obs$Year)

######## LOAD BHG NESTING SUCCESS ####################################
#black-headed gull #Śmieszka #(Chroicocephalus ridibundus)
#former b_gull
bh_gull_NS <- data.frame( read.csv("D:/Ptaki_hydro/Obliczenia/R/Birds/b_gull_na.csv")) %>%
  remove_rownames %>% column_to_rownames(var="X")

bh_gull_NS_list <-list(
  "910"=list(NS=bh_gull_NS[ ,21:22],Year=Years_x), 
  "950"=list(NS=bh_gull_NS[ ,19:20],Year=Years_x), 
  "1012"=list(NS=bh_gull_NS[ ,18],Year=Years_x), 
  "1087"=list(NS=bh_gull_NS[ ,17],Year=Years_x), 
  "1134"=list(NS=bh_gull_NS[ ,15:16],Year=Years_x),
  "1240"=list(NS=bh_gull_NS[ ,13:14],Year=Years_x),
  "1264"=list(NS=bh_gull_NS[ ,12],Year=Years_x),
  "1289"=list(NS=bh_gull_NS[ ,11],Year=Years_x), 
  "1329"=list(NS=bh_gull_NS[ ,10],Year=Years_x),
  "1358"=list(NS=bh_gull_NS[ ,9],Year=Years_x),
  "1501"=list(NS=bh_gull_NS[ ,8],Year=Years_x), 
  "1545"=list(NS=bh_gull_NS[ ,7],Year=Years_x),
  "1565"=list(NS=bh_gull_NS[ ,6],Year=Years_x),
  "1601"=list(NS=bh_gull_NS[ ,5],Year=Years_x),
  "1629"=list(NS=bh_gull_NS[ ,4],Year=Years_x), 
  "1727"=list(NS=bh_gull_NS[ ,3],Year=Years_x),
  "1748"=list(NS=bh_gull_NS[ ,2],Year=Years_x),
  "1875"=list(NS=bh_gull_NS[ ,1],Year=Years_x))
 

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%% MEW GULL (MG) %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
#Narrowing the data to vulnerability period for common gull : 21.04 - 30.06
#Mew gull #mewa siwa #(Larus canus)

###### MODELLED Q 
m.gull_interv <- as.interval(ddays(71), start = ISOdate(2004:2018, 4, 21, 0, tz = 'Europe/Warsaw'))
m.gull_is.breeding <- Q_mod_Wisla$date %within% as.list(m.gull_interv)
m.gull_dat <- (Q_mod_Wisla$date)[which(m.gull_is.breeding)]

#Narrow down the Q data to vulnerability period
m.gull_Q_mod <- Q_mod_Wisla[Q_mod_Wisla$date %in% m.gull_dat, ] 

m.gull_Q_mod$Year <- format(as.Date(m.gull_Q_mod$date, format="%Y-%m-%d"),"%Y")

#list with each year as separate data frame
#former Mewa_list
m.gull_Q_mod_list <- m.gull_Q_mod %>% group_split(m.gull_Q_mod$Year)

###### OBSERVED Q 

m.gull_is.breeding.obs <- obs_Wisla$date %within% as.list(m.gull_interv)
m.gull_dat2 <- (obs_Wisla$date)[which(m.gull_is.breeding.obs)]

#Narrow down the Q data to vulnerability period
m.gull_Q_obs <- obs_Wisla[obs_Wisla$date %in% m.gull_dat2, ] 

m.gull_Q_obs$Year <- format(as.Date(m.gull_Q_obs$date, format="%Y-%m-%d"),"%Y")

#list with each year as separate data frame
#former Mewa_obs_list
m.gull_Q_obs_list <- m.gull_Q_obs %>% group_split(m.gull_Q_obs$Year)


######## LOAD MG NESTING SUCCESS ####################################
#mew gull #mewa siwa #(Larus canus)

m_gull_NS <- data.frame( read.csv("D:/Ptaki_hydro/Obliczenia/R/Birds/c_gull.csv"))%>%
  remove_rownames %>% column_to_rownames(var="X")

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%% LITTLE TERN (LT) %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
#Narrowing the data to vulnerability period for little tern : 11.05 - 10.07
#little tern #rybitwa białoczelna #(Sternula albifrons)

###### MODELLED Q 
tern_interv <- as.interval(ddays(61), start = ISOdate(2004:2018, 5, 11, 0, tz = 'Europe/Warsaw'))
tern_is.breeding <- Q_mod_Wisla$date %within% as.list(tern_interv)
tern_dat <- (Q_mod_Wisla$date)[which(tern_is.breeding)]

#Narrow down the Q data to vulnerability period
tern_Q_mod <- Q_mod_Wisla[Q_mod_Wisla$date %in% tern_dat, ] 

tern_Q_mod$Year <- format(as.Date(tern_Q_mod$date, format="%Y-%m-%d"),"%Y")

#list with each year as separate data frame
#former Rybitwa_list
tern_Q_mod_list <- tern_Q_mod %>% group_split(tern_Q_mod$Year)

###### OBSERVED Q 

tern_is.breeding.obs <- obs_Wisla$date %within% as.list(tern_interv)
tern_dat2 <- (obs_Wisla$date)[which(tern_is.breeding.obs)]

#Narrow down the Q data to vulnerability period
tern_Q_obs <- obs_Wisla[obs_Wisla$date %in% tern_dat2, ] 

tern_Q_obs$Year <- format(as.Date(tern_Q_obs$date, format="%Y-%m-%d"),"%Y")

#list with each year as separate data frame
#former Rybitwa_obs_list
tern_Q_obs_list <- tern_Q_obs %>% group_split(tern_Q_obs$Year)


######## LOAD LT NESTING SUCCESS ####################################
#little tern #rybitwa białoczelna #(Sternula albifrons)
tern_NS <- data.frame( read.csv("D:/Ptaki_hydro/Obliczenia/R/Birds/tern_na.csv"))%>% 
  remove_rownames %>% column_to_rownames(var="X")

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
